<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>Proposal: Generating Contacts for Parametric Opaque Types</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="" class="tocviewselflink" data-pltdoc="x">Proposal:<span class="mywbr"> &nbsp;</span> Generating Contacts for Parametric Opaque Types</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#%28part._.Current_contract_behavior_for_parametric__non-opaque_types%29" class="tocviewlink" data-pltdoc="x">Current contract behavior for parametric, non-<wbr></wbr>opaque types</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#%28part._.Extending_parametricity_to_opaque_types%29" class="tocviewlink" data-pltdoc="x">Extending parametricity to opaque types</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="#%28part._.A_request_for_feedback_and_proposal_to_implement_parametric_opaque_types%29" class="tocviewlink" data-pltdoc="x">A request for feedback and proposal to implement parametric opaque types</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber"></span><a href="#%28part._.Proposal__.Generating_.Contacts_for_.Parametric_.Opaque_.Types%29" class="tocsubseclink" data-pltdoc="x">Proposal:<span class="mywbr"> &nbsp;</span> Generating Contacts for Parametric Opaque Types</a></td></tr><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#%28part._.Current_contract_behavior_for_parametric__non-opaque_types%29" class="tocsubseclink" data-pltdoc="x">Current contract behavior for parametric, non-<wbr></wbr>opaque types</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#%28part._.Extending_parametricity_to_opaque_types%29" class="tocsubseclink" data-pltdoc="x">Extending parametricity to opaque types</a></td></tr><tr><td><span class="tocsublinknumber">2.1<tt>&nbsp;</tt></span><a href="#%28part._.Creating_an_idealized_syntax_for_describing_parametric_opaque_imports%29" class="tocsubseclink" data-pltdoc="x">Creating an idealized syntax for describing parametric opaque imports</a></td></tr><tr><td><span class="tocsublinknumber">2.2<tt>&nbsp;</tt></span><a href="#%28part._.Using_parametric_opaque_types_in_typed_code%29" class="tocsubseclink" data-pltdoc="x">Using parametric opaque types in typed code</a></td></tr><tr><td><span class="tocsublinknumber">2.3<tt>&nbsp;</tt></span><a href="#%28part._.Using_parametric_opaque_types_with_untyped_code%29" class="tocsubseclink" data-pltdoc="x">Using parametric opaque types with untyped code</a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#%28part._.A_request_for_feedback_and_proposal_to_implement_parametric_opaque_types%29" class="tocsubseclink" data-pltdoc="x">A request for feedback and proposal to implement parametric opaque types</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="versionNoNav">6.1.1.8</span></div><h2><a name="(part._.Proposal__.Generating_.Contacts_for_.Parametric_.Opaque_.Types)"></a>Proposal: Generating Contacts for Parametric Opaque Types</h2><h3>1<tt>&nbsp;</tt><a name="(part._.Current_contract_behavior_for_parametric__non-opaque_types)"></a>Current contract behavior for parametric, non-opaque types</h3><p>Currently, Typed Racket makes relatively weak guarantees when using parametric structural types from
untyped code. This is unfortunately necessary since parametricity really only exists as a static
construct. Without instantiating the types, contracts cannot be made. This allows programs like the
following to successfully run.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/module.html#%28form._%28%28quote._~23~25kernel%29._module%29%29" class="RktStxLink" data-pltdoc="x">module</a></span><span class="hspace">&nbsp;</span><span class="RktSym">typed</span><span class="hspace">&nbsp;</span><span class="RktSym">typed/racket/base</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29" class="RktStxLink" data-pltdoc="x">provide</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct-out%29%29" class="RktStxLink" data-pltdoc="x">struct-out</a></span><span class="hspace">&nbsp;</span><span class="RktSym">Foo</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._struct%29%29" class="RktStxLink" data-pltdoc="x">struct</a></span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktSym">Foo</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._~3a%29%29" class="RktStxLink" data-pltdoc="x">:</a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">y</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._~3a%29%29" class="RktStxLink" data-pltdoc="x">:</a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">typed</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">Foo</span><span class="hspace">&nbsp;</span><span class="RktVal">"a"</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">b</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">(Foo <span class="stt"> </span>"a"<span class="stt"> </span>'b)</span></p></td></tr></table></blockquote><p>Obviously, it would be impossible to know that <span class="RktVal">"a"</span> and <span class="RktVal">'</span><span class="RktVal">b</span> are of different types
because the concept of "types" does not exist at runtime. However, the following program demonstrates
how Typed Racket prevents this lack of knowledge from "infecting" the typed code.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/module.html#%28form._%28%28quote._~23~25kernel%29._module%29%29" class="RktStxLink" data-pltdoc="x">module</a></span><span class="hspace">&nbsp;</span><span class="RktSym">typed-concat</span><span class="hspace">&nbsp;</span><span class="RktSym">typed/racket/base</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">typed</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29" class="RktStxLink" data-pltdoc="x">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">foo-concat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">foo-concat</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">foo</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._~3a%29%29" class="RktStxLink" data-pltdoc="x">:</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Foo</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.String%29%29" class="RktStxLink" data-pltdoc="x">String</a></span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._~3a%29%29" class="RktStxLink" data-pltdoc="x">:</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.String%29%29" class="RktStxLink" data-pltdoc="x">String</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string-append%29%29" class="RktValLink" data-pltdoc="x">string-append</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Foo-x</span><span class="hspace">&nbsp;</span><span class="RktSym">foo</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Foo-y</span><span class="hspace">&nbsp;</span><span class="RktSym">foo</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">typed-concat</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">foo-concat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Foo</span><span class="hspace">&nbsp;</span><span class="RktVal">"a"</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">foo-concat: contract violation</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">expected: String</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">given: 'b</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">in: the (#:selector Foo-y) field of</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">the 1st argument of</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">(-&gt; (struct/c Foo String String) any)</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">contract from: typed-concat</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">blaming: program</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;</span><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">(assuming the contract is correct)</span></p></td></tr><tr><td><p><span class="RktErr"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktErr">at: eval:4.0</span></p></td></tr></table></blockquote><p>This demonstrates that parametric structure types are something of a derived concept in Typed Racket,
despite being technically only being possible due to the <span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._struct%29%29" class="RktStxLink" data-pltdoc="x">struct</a></span> special form. Importantly,
the fact that <span class="RktSym">Foo</span> is parametric does not cause any additional contracts to be generated since
<span class="RktSym">A</span> is directly used as a field type. Contracts are only created at the <span style="font-style: italic">point of
instantiation</span>.</p><h3>2<tt>&nbsp;</tt><a name="(part._.Extending_parametricity_to_opaque_types)"></a>Extending parametricity to opaque types</h3><p>If parameterized types are a wholly static concept, they should, in theory, be able to be extended to
opaque types. As an example, consider the <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span> structure from <a href="http://docs.racket-lang.org/htdp/index.html#%28mod-path._lang%2Fposn%29" class="RktModLink" data-pltdoc="x"><span class="RktSym">lang/posn</span></a>. This
structure contains two fields of any type, but <a href="http://docs.racket-lang.org/teachpack/2htdpimage.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">2htdp/image</span></a> provides
<span class="RktSym"><a href="http://docs.racket-lang.org/teachpack/2htdpimage.html#%28def._%28%28lib._2htdp%2Fimage..rkt%29._real-valued-posn~3f%29%29" class="RktValLink" data-pltdoc="x">real-valued-posn?</a></span> as a predicate for use in contracts. Ideally, we would be able to express
this in Typed Racket as a parameterized type.</p><p>A na&#239;ve attempt to use such a type in typed code might look something like this:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">make Posn parametric</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed%2Fracket%2Fbase..rkt%29._define-type%29%29" class="RktStxLink" data-pltdoc="x">define-type</a></span><span class="hspace">&nbsp;</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">htdp:posn</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._provide%29%29" class="RktStxLink" data-pltdoc="x">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">Posn</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._require%2Ftyped%29%29" class="RktStxLink" data-pltdoc="x">require/typed</a></span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktSym">lang/posn</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktPn">#:opaque</span><span class="hspace">&nbsp;</span><span class="RktSym">htdp:posn</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn~3f%29%29" class="RktValLink" data-pltdoc="x">posn?</a></span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._require%2Ftyped%2Fprovide%29%29" class="RktStxLink" data-pltdoc="x">require/typed/provide</a></span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktSym">lang/posn</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._make-posn%29%29" class="RktValLink" data-pltdoc="x">make-posn</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-y%29%29" class="RktValLink" data-pltdoc="x">posn-y</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Sadly, this fails. Typed Racket attempts to apply a <span class="RktSym"><a href="http://docs.racket-lang.org/reference/parametric-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fparametric..rkt%29._parametric-~3e%2Fc%29%29" class="RktStxLink" data-pltdoc="x">parametric-&gt;/c</a></span> contract to the various
<span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span> functions, and the values are wrapped. The wrapping and unwrapping functions are not
shared between functions, so attempting to retrieve values from <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span> instances raises
contract errors. Furthermore, even if the wrappers <span style="font-style: italic">were</span> shared between functions, untyped
code would recieved wrapped values, which would render them quite useless.</p><p>However, as mentioned above, all of the contract checking on these functions can be done from the
<span style="font-style: italic">typed</span> side at runtime. Typed Racket just needs some information about how to correctly
generate contracts on opaque types.</p><h4>2.1<tt>&nbsp;</tt><a name="(part._.Creating_an_idealized_syntax_for_describing_parametric_opaque_imports)"></a>Creating an idealized syntax for describing parametric opaque imports</h4><p>The rest of the code in this document will be somewhat hypothetical and demonstrative. In order to
demonstrate the way the system <span style="font-style: italic">should</span> work, there needs to be some basic syntax that can
express the required ideas. The issues of implemented such forms is a problem not addressed by this
document, but it is assumed to be trivial in comparison to the other problems laid out.</p><p>The proposed syntax to instruct Typed Racket to formulate a parametric type is as follows:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._require%2Ftyped%29%29" class="RktStxLink" data-pltdoc="x">require/typed</a></span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktPn">#:opaque</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn~3f%29%29" class="RktValLink" data-pltdoc="x">posn?</a></span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._make-posn%29%29" class="RktValLink" data-pltdoc="x">make-posn</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-y%29%29" class="RktValLink" data-pltdoc="x">posn-y</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._.All%29%29" class="RktStxLink" data-pltdoc="x">All</a></span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">A</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="hspace">&nbsp;</span><span class="RktSym">A</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr></table></blockquote><p>There are some important notes about this syntax.</p><ul><li><p>The actual important part occurs within the <span class="RktPn">#:opaque</span> declaration. This declares
<span class="RktSym">Posn</span> as a <a name="(tech._parametric._opaque._type)"></a><span style="font-style: italic">parametric opaque type</span>. This will need to be something of a
first-class member of Typed Racket&rsquo;s type system, just as much as structure types are.</p></li><li><p>In the various function declarations, the type of <span class="RktSym">A</span> is inferred from the arguments,
just as in any other parametric type declaration. No wrapping or unwrapping is needed via
<span class="RktSym"><a href="http://docs.racket-lang.org/reference/parametric-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fparametric..rkt%29._parametric-~3e%2Fc%29%29" class="RktStxLink" data-pltdoc="x">parametric-&gt;/c</a></span>. This guarantee is important! As mentioned earlier, any wrapping or
unwrapping required by these functions will break interoperability with untyped Racket.</p></li></ul><h4>2.2<tt>&nbsp;</tt><a name="(part._.Using_parametric_opaque_types_in_typed_code)"></a>Using parametric opaque types in typed code</h4><p>Just as with parametric structure types, <a href="#%28tech._parametric._opaque._type%29" class="techoutside" data-pltdoc="x"><span class="techinside">parametric opaque types</span></a> can be handled purely by the
static typechecker as long as they stay in typed code. Of course, the major difference is that
parametric opaque types must interact with untyped code <span style="font-style: italic">by definition</span>, since they are opaque.
Even trickier, we cannot generate contracts as simply as we did with our <span class="RktSym">Foo</span> structure and
the <span class="RktSym">foo-concat</span> function that used its instantiation. Why? Consider the following code.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._~3a%29%29" class="RktStxLink" data-pltdoc="x">:</a></span><span class="hspace">&nbsp;</span><span class="RktSym">posn-2x</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">Posn</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.Real%29%29" class="RktStxLink" data-pltdoc="x">Real</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types-extra..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.Real%29%29" class="RktStxLink" data-pltdoc="x">Real</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">posn-2x</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._%2A%29%29" class="RktValLink" data-pltdoc="x">*</a></span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">posn-2x</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._make-posn%29%29" class="RktValLink" data-pltdoc="x">make-posn</a></span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This should work! But what if our untyped code misbehaves? What if, instead of getting
<span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span><span class="stt"> </span><span class="RktVal">2</span><span class="stt"> </span><span class="RktVal">4</span><span class="RktPn">)</span> from <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._make-posn%29%29" class="RktValLink" data-pltdoc="x">make-posn</a></span>, the untyped code returns <span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span><span class="stt"> </span><span class="RktVal">2</span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">error</span><span class="RktPn">)</span>? This
is surprisingly problematic because, in <span class="RktSym">posn-2x</span>, there is <span style="font-style: italic">no way for Typed Racket to
validate the provided value at runtime!</span> Since <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-y%29%29" class="RktValLink" data-pltdoc="x">posn-y</a></span> is never used, as far as Typed Racket
knows, everything is going just fine. And that&rsquo;s actually okay. The types aren&rsquo;t broken because
<span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span> is correct. Ideally, we&rsquo;d get a contract failure, but technically nothing has gone
wrong here.</p><p>But what about the other case? What if the returned value is completely bogus? What if
<span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._make-posn%29%29" class="RktValLink" data-pltdoc="x">make-posn</a></span> yields <span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span><span class="stt"> </span><span class="RktVal">#f</span><span class="stt"> </span><span class="RktVal">#f</span><span class="RktPn">)</span>? Now we need to produce some kind of contract failure.
Obviously, the call to <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span> in the typed code should be protected with a contract ensuring
that the return value is a <span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.Real%29%29" class="RktStxLink" data-pltdoc="x">Real</a></span>. That&rsquo;s not too hard&#8212;problem solved!</p><p>Unfortunately, it&rsquo;s unclear exactly <span style="font-style: italic">how</span> the contract should be attached to <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span>.
It can&rsquo;t be attached in <span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/special-forms.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fprims..rkt%29._require%2Ftyped%29%29" class="RktStxLink" data-pltdoc="x">require/typed</a></span> because the contract depends entirely on the type
instantiation. Indeed, the contract needs to be attached in an on-demand basis. Typed Racket needs to
infer that the call to <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span> is being applied with <span class="RktSym"><a href="http://docs.racket-lang.org/ts-reference/type-ref.html#%28form._%28%28lib._typed-racket%2Fbase-env%2Fbase-types..rkt%29._.Real%29%29" class="RktStxLink" data-pltdoc="x">Real</a></span> as the concrete type, and
it needs to produce a chaperoned function in place of <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn-x%29%29" class="RktValLink" data-pltdoc="x">posn-x</a></span> that will ensure its return type
satisfies <span class="RktSym"><a href="http://docs.racket-lang.org/reference/number-types.html#%28def._%28%28quote._~23~25kernel%29._real~3f%29%29" class="RktValLink" data-pltdoc="x">real?</a></span>.</p><p>The precise mechanism by which the typechecker would be able to handle such a situation is unknown to
me. The best approach would probably hinge on ensuring optimal performance. Either way, it seems that
such a solution is well within the range of Typed Racket&rsquo;s operational functionality.</p><h4>2.3<tt>&nbsp;</tt><a name="(part._.Using_parametric_opaque_types_with_untyped_code)"></a>Using parametric opaque types with untyped code</h4><p>This area is something I haven&rsquo;t given a huge amount of thought to, though it <span style="font-style: italic">is</span> relevant:
what should the behavior be when exporting identifiers that interact with <a href="#%28tech._parametric._opaque._type%29" class="techoutside" data-pltdoc="x"><span class="techinside">parametric opaque
types</span></a>, especially when imported into untyped modules? For the most part, the behavior described for
interactions in typed code seem to generalize to untyped code, maintaining the parallel between
parametric structure types and parametric opaque types.</p><p>Just like in the original example given using a parametric structure type, it would be impossible to
enforce such constraints in untyped code without type instantiation, similar to the equivalent problem
from the typed side of things.</p><h3>3<tt>&nbsp;</tt><a name="(part._.A_request_for_feedback_and_proposal_to_implement_parametric_opaque_types)"></a>A request for feedback and proposal to implement parametric opaque types</h3><p>At this point, I will take the opportunity to speak for myself and admit that I am not terribly
familiar with how Typed Racket&rsquo;s typechecker and type environment work on the inside. I am certainly
willing to attempt to implement something like this myself, but seeing as this is all quite
hypothetical from my perspective, it would help to get the opinions of those more familiar with how
these things are implemented.</p><p>I <span style="font-style: italic">do</span> believe that the implementation of such a system has the possibility of permitting the
use of various untyped idioms in typed code. Besides HtDP&rsquo;s <span class="RktSym"><a href="http://docs.racket-lang.org/htdp/index.html#%28def._%28%28lib._lang%2Fposn..rkt%29._posn%29%29" class="RktValLink" data-pltdoc="x">posn</a></span> type, the <span class="RktSym"><a href="http://docs.racket-lang.org/json/index.html#%28def._%28%28lib._json%2Fmain..rkt%29._jsexpr~3f%29%29" class="RktValLink" data-pltdoc="x">jsexpr?</a></span>
type from the JSON library comes to mind with its support for custom nulls. This is an immediate
application of such a feature, and I could see it being made useful in other areas as well.</p><p>I would appreciate any comments on this proposal as well as any aid anyone is willing to give me to
assist in my eventual implementation of parametricity for opaque types. Please do not hesitate to
critique or make suggestions, as this is still a very simple draft, and I recognize that it might need
some major changes before being viable.</p></div></div><div id="contextindicator">&nbsp;</div></body></html>